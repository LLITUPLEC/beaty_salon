#!/bin/bash

# ============================================
# Git Pull + Deploy Script –¥–ª—è VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./git-pull.sh
# ============================================

# === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
# –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –∏ –∑–∞–ø–æ–ª–Ω–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ URL
# (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ - –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSH –∫–ª—é—á–∏)
# GIT_USER="—Ç–≤–æ–π_–ª–æ–≥–∏–Ω"
# GIT_PASS="—Ç–≤–æ–π_–ø–∞—Ä–æ–ª—å_–∏–ª–∏_—Ç–æ–∫–µ–Ω"
# GIT_REPO="github.com/username/repo.git"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/var/www/beauty-salon/app"
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:
# PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"

# ============================================

echo ""
echo "========================================"
echo "üîÑ Git Pull + Deploy - Beauty Salon"
echo "========================================"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
if [ -d "$PROJECT_DIR" ]; then
    cd "$PROJECT_DIR"
    echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PROJECT_DIR"
else
    echo "üìÇ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $(pwd)"
fi

# –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ URL (–Ω–µ SSH)
# if [ -n "$GIT_USER" ] && [ -n "$GIT_PASS" ]; then
#     git remote set-url origin "https://${GIT_USER}:${GIT_PASS}@${GIT_REPO}"
# fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
if ! git diff --quiet; then
    echo "‚ö†Ô∏è  –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ stash..."
    git stash
    STASHED=1
else
    STASHED=0
fi

# –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
echo ""
echo "‚¨áÔ∏è  –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π..."
git fetch origin

# –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üåø –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $BRANCH"

# Pull
echo ""
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
git pull origin "$BRANCH"

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ pull. –í–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã."
    exit 1
fi

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º stash (–µ—Å–ª–∏ –±—ã–ª)
if [ $STASHED -eq 1 ]; then
    echo ""
    echo "üìã –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    git stash pop
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ package.json –∏–∑–º–µ–Ω–∏–ª—Å—è)
echo ""
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞
echo ""
echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞..."
npx prisma generate

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
echo ""
echo "üóÉÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
npx prisma db push

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Next.js
echo ""
echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
pm2 restart all

# –°—Ç–∞—Ç—É—Å
echo ""
echo "========================================"
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
echo "========================================"
echo ""
pm2 status

